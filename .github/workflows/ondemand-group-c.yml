name: OnDemand-Group-C

on:
  schedule:
    - cron: '5 * * * *'   # every hour at :05
  workflow_dispatch:

jobs:
  run_cat_group_c:
    runs-on: ubuntu-latest
    steps:
      - name: Run ONE category per run (limit=650)
        shell: bash
        run: |
          set -euo pipefail

          CATS=(
            "Beauty & Personal Care|6205124011"
            "Clothing Men|21353444011"
            "Clothing Women|21353446011"
            "Grocery|6967215011"
            "Health & Personal Care|6205177011"
          )

          IDX=$(( ( $(date +%s) / 3600 ) % ${#CATS[@]} ))
          ENTRY="${CATS[$IDX]}"

          LABEL="${ENTRY%%|*}"
          CATID="${ENTRY##*|}"

          BASE_URL="${{ secrets.ONDEMAND_URL }}"
          SECRET="${{ secrets.ONDEMAND_SECRET }}"

          if [[ -z "$BASE_URL" ]]; then
            echo "ERROR: ONDEMAND_URL secret is empty."
            exit 1
          fi

          # If BASE_URL already has a "?" then append with "&", otherwise with "?"
          SEP='?'
          [[ "$BASE_URL" == *\?* ]] && SEP='&'

          FINAL_URL="${BASE_URL}${SEP}secret=${SECRET}&task=cat:${CATID}&limit=650"

          echo "Running: ${LABEL} (${CATID})"
          echo "URL (redacted secret): ${BASE_URL}${SEP}secret=***&task=cat:${CATID}&limit=650"

          curl -sS -L --fail "$FINAL_URL" | head -c 500
          echo ""
