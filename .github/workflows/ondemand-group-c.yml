name: OnDemand-Group-C

on:
  schedule:
    - cron: '10 * * * *'   # minute 10 of every hour (UTC)
  workflow_dispatch:

concurrency:
  group: ondemand
  cancel-in-progress: false

permissions:
  actions: write
  contents: read

jobs:
  run_cat_group_c:
    runs-on: ubuntu-latest
    steps:
      - name: Run 11 categories (limit=650, 5 min spacing)
        shell: bash
        run: |
          set -euo pipefail

          LIMIT=650
          SLEEP_SECONDS=$((5*60))

          declare -a cats=(
            "Beauty & Personal Care"
            "Clothing Men"
            "Clothing Women"
            "Grocery"
            "Health & Personal Care"
            "Home & Kitchen"
            "Office Products"
            "Pett Supplies"
            "Sports & Outdoors"
            "Tools & Home Improvement"
            "Toys & Games"
          )

          failures=0
          echo "Total categories: ${#cats[@]}"
          echo "Limit: $LIMIT"

          for i in "${!cats[@]}"; do
            cat="${cats[$i]}"
            slug=$(python3 -c 'import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1]))' "$cat")

            echo "[$(date -u)] ($((i+1))/${#cats[@]}) calling: $cat (limit=$LIMIT)"

            http_code=$(curl -sS -L --max-redirs 5 --fail-with-body \
              -o /tmp/resp.txt -w "%{http_code}" \
              "${{ secrets.OND_WEBAPP }}?secret=${{ secrets.OND_SECRET }}&task=$slug&limit=$LIMIT" \
              || echo "000")

            if [[ "$http_code" != "200" ]]; then
              echo "::warning::HTTP $http_code for '$cat'"
              echo "Response (last 50 lines):"
              tail -n 50 /tmp/resp.txt || true
              failures=$((failures+1))
            fi

            [[ $i -lt $((${#cats[@]}-1)) ]] && sleep "$SLEEP_SECONDS"
          done

          echo "Finished. failures=$failures"
          [[ $failures -eq 0 ]] || exit 1

      - name: Trigger Group D after Group C completes
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          echo "Triggering OnDemand-Group-D via workflow_dispatch..."

          curl -sS -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/ondemand-group-d.yml/dispatches \
            -d '{"ref":"main"}'
