name: OnDemand-Group-C-Day-650

on:
  schedule:
    - cron: '10 18-23 * * *'  # 18:10–23:10 UTC = 1:10–6:10pm Québec (EST)
  workflow_dispatch:

concurrency:
  group: ondemand-c
  cancel-in-progress: false

jobs:
  run_cat_group_c:
    runs-on: ubuntu-latest
    steps:
      - name: Run ONE category per run (limit=650) — Group C (1:10–6:10pm Québec)
        shell: bash
        run: |
          set -euo pipefail

          # IMPORTANT: Use cat:<ID> so it always matches your Apps Script doGet() handler.
          # These IDs come from your ONDEMAND_CATEGORY_ARRAY.
          declare -a tasks=(
            "cat:2224199011"   # Home Storage & Organization (same ID as Storage & Organization)
            "cat:2224027011"   # Home Décor
            "cat:2224159011"   # Patio Furniture & Accessories
            "cat:2224158011"   # Outdoor Décor
            "cat:2224149011"   # Garden Structures & Germination Equipment
            "cat:6257202011"   # Outdoor Cooking
          )

          HOUR_UTC="$(date -u +%H)"

          # Map 18..23 UTC => 6 slots
          case "$HOUR_UTC" in
            18) idx=0 ;;
            19) idx=1 ;;
            20) idx=2 ;;
            21) idx=3 ;;
            22) idx=4 ;;
            23) idx=5 ;;
            *)  echo "Outside Group C window. Exiting."; exit 0 ;;
          esac

          task="${tasks[$idx]}"

          echo "[$(date -u)] Group C idx=$idx task='$task' limit=650"

          http_code="$(curl -sS --fail-with-body \
            -o /tmp/resp.txt -w "%{http_code}" \
            "${{ secrets.OND_WEBAPP }}?secret=${{ secrets.OND_SECRET }}&task=$task&limit=650" \
            || echo "000")"

          echo "HTTP $http_code"
          echo "Response (last 50 lines):"
          tail -n 50 /tmp/resp.txt || true

          # Fail if HTTP is not 200
          if [[ "$http_code" != "200" ]]; then
            echo "::error::HTTP $http_code from backend"
            exit 1
          fi

          # Fail if backend says Unknown task (even if HTTP 200)
          if grep -qi 'Unknown task' /tmp/resp.txt; then
            echo "::error::Backend rejected task '$task' (Unknown task)"
            exit 1
          fi

          echo "OK"
