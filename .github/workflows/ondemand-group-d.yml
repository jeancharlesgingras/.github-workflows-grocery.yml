name: OnDemand-Group-D

on:
  schedule:
    - cron: '35 * * * *'  # every hour at :35
  workflow_dispatch:

jobs:
  run_cat_group_d:
    runs-on: ubuntu-latest
    steps:
      - name: Run ONE category per run (limit=650)
        shell: bash
        run: |
          set -euo pipefail

          CATS=(
            "Home & Kitchen|2206275011"
            "Office Products|6205511011"
            "Pet Supplies|6205514011"
            "Sports & Outdoors|2242989011"
            "Tools & Home Improvement|3006902011"
            "Toys & Games|6205517011"
          )

          IDX=$(( ( $(date +%s) / 3600 ) % ${#CATS[@]} ))
          ENTRY="${CATS[$IDX]}"

          LABEL="${ENTRY%%|*}"
          CATID="${ENTRY##*|}"

          BASE_URL="${{ secrets.ONDEMAND_URL }}"
          SECRET="${{ secrets.ONDEMAND_SECRET }}"

          if [[ -z "$BASE_URL" ]]; then
            echo "ERROR: ONDEMAND_URL secret is empty."
            exit 1
          fi

          SEP='?'
          [[ "$BASE_URL" == *\?* ]] && SEP='&'

          FINAL_URL="${BASE_URL}${SEP}secret=${SECRET}&task=cat:${CATID}&limit=650"

          echo "Running: ${LABEL} (${CATID})"
          echo "URL (redacted secret): ${BASE_URL}${SEP}secret=***&task=cat:${CATID}&limit=650"

          curl -sS -L --fail "$FINAL_URL" | head -c 500
          echo ""
