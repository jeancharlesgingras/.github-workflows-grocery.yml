name: OnDemand-Group-D-Day-650

on:
  schedule:
    - cron: '10 0-5 * * *'  # 00:10–05:10 UTC = 7:10pm–12:10am Québec (EST)
  workflow_dispatch:

concurrency:
  group: ondemand-d
  cancel-in-progress: false

jobs:
  run_cat_group_d:
    runs-on: ubuntu-latest
    steps:
      - name: Run ONE category per run (limit=650) — Group D (7:10pm–12:10am Québec)
        shell: bash
        run: |
          set -euo pipefail

          # IDs come from your ONDEMAND_CATEGORY_ARRAY.
          declare -a tasks=(
            "cat:2406064011"    # Sports Fan Shop
            "cat:6369740011"    # Diet & Nutrition Products
            "cat:23760073011"   # Snacks & Sweets
            "cat:7351934011"    # Cooking & Baking Supplies
            "cat:6369959011"    # Health Care Products
            "cat:3561346011"    # Baby
          )

          HOUR_UTC="$(date -u +%H)"

          # Map 00..05 UTC => 6 slots
          case "$HOUR_UTC" in
            00) idx=0 ;;
            01) idx=1 ;;
            02) idx=2 ;;
            03) idx=3 ;;
            04) idx=4 ;;
            05) idx=5 ;;
            *)  echo "Outside Group D window. Exiting."; exit 0 ;;
          esac

          task="${tasks[$idx]}"

          echo "[$(date -u)] Group D idx=$idx task='$task' limit=650"

          http_code="$(curl -sS --fail-with-body \
            -o /tmp/resp.txt -w "%{http_code}" \
            "${{ secrets.OND_WEBAPP }}?secret=${{ secrets.OND_SECRET }}&task=$task&limit=650" \
            || echo "000")"

          echo "HTTP $http_code"
          echo "Response (last 50 lines):"
          tail -n 50 /tmp/resp.txt || true

          if [[ "$http_code" != "200" ]]; then
            echo "::error::HTTP $http_code from backend"
            exit 1
          fi

          if grep -qi 'Unknown task' /tmp/resp.txt; then
            echo "::error::Backend rejected task '$task' (Unknown task)"
            exit 1
          fi

          echo "OK"
