name: OnDemand-Group-C-Day-650

on:
  schedule:
    - cron: '10 * * * *'   # every hour at :10 UTC; script enforces 1–11pm Quebec
  workflow_dispatch:

concurrency:
  group: ondemand-c
  cancel-in-progress: false

jobs:
  run_cat_group_c:
    runs-on: ubuntu-latest
    steps:
      - name: Run ONE category per hour (limit=650) during 1–11pm Quebec
        shell: bash
        run: |
          set -euo pipefail

          declare -a cats=(
            "Health & Personal Care"
            "Tools & Home Improvement"
            "Kitchen & Dining"
            "Grocery"
            "Toys & Games"
            "Sports & Outdoors"
            "Beauty"
            "Baby"
            "Pet Supplies"
            "Office Products"
            "Patio, Lawn & Garden"
          )

          HOUR_QC="$(TZ=America/Toronto date +%H)"

          if [[ "$HOUR_QC" -lt 13 || "$HOUR_QC" -gt 23 ]]; then
            echo "Outside 1–11pm Quebec window. QC hour=$HOUR_QC. Exiting."
            exit 0
          fi

          idx=$((HOUR_QC - 13))
          cat="${cats[$idx]}"
          slug="$(python3 -c 'import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1]))' "$cat")"

          echo "UTC now: $(date -u)"
          echo "QC  now: $(TZ=America/Toronto date)"
          echo "slot idx=$idx category='$cat' limit=650"

          http_code="$(curl -sS --fail-with-body \
            -o /tmp/resp.txt -w "%{http_code}" \
            "${{ secrets.OND_WEBAPP }}?secret=${{ secrets.OND_SECRET }}&task=$slug&limit=650" \
            || echo "000")"

          if [[ "$http_code" != "200" ]]; then
            echo "::warning::HTTP $http_code for '$cat'"
            echo "Response (last 50 lines):"
            tail -n 50 /tmp/resp.txt || true
            exit 1
          fi

          echo "OK (HTTP 200). Response (last 30 lines):"
          tail -n 30 /tmp/resp.txt || true
