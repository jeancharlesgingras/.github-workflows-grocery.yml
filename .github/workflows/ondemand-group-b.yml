name: OnDemand-Group-B

on:
  schedule:
    # 06:10 Quebec time year-round:
    # - 11:10 UTC = 06:10 EST (winter)
    # - 10:10 UTC = 06:10 EDT (summer)
    - cron: '10 10 * * *'
    - cron: '10 11 * * *'
  workflow_dispatch:

concurrency:
  group: ondemand
  cancel-in-progress: false

jobs:
  run_cat_group_b:
    runs-on: ubuntu-latest
    steps:
      - name: Run 16 categories (20 min spacing)
        shell: bash
        run: |
          set -euo pipefail

          # ---- DST-safe gate: run only when it's 06:10 in Quebec ----
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y tzdata >/dev/null
          export TZ="America/Toronto"

          local_hour="$(date +%H)"
          local_min="$(date +%M)"
          if [[ "$local_hour" != "06" || "$local_min" != "10" ]]; then
            echo "Not 06:10 in Quebec (America/Toronto). It's $(date). Exiting successfully."
            exit 0
          fi

          declare -a cats=(
            "Home Storage & Organization" "Home Décor"
            "Patio Furniture & Accessories" "Outdoor Décor"
            "Garden Structures & Germination Equipment" "Outdoor Cooking"
            "Sports Fan Shop" "Diet & Nutrition Products"
            "Snacks & Sweets" "Cooking & Baking Supplies"
            "Health Care Products" "Tableware" "Kitchen Cookware"
            "Baby" "Sports & Outdoors" "Women Fashion"
          )

          failures=0
          echo "Total categories: ${#cats[@]}"

          for i in "${!cats[@]}"; do
            cat="${cats[$i]}"
            slug=$(python3 -c 'import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1]))' "$cat")

            echo "[$(date)] ($((i+1))/${#cats[@]}) calling: $cat"

            http_code=$(curl -sS --fail-with-body \
              -o /tmp/resp.txt -w "%{http_code}" \
              "${{ secrets.OND_WEBAPP }}?secret=${{ secrets.OND_SECRET }}&task=$slug" \
              || echo "000")

            if [[ "$http_code" != "200" ]]; then
              echo "::warning::HTTP $http_code for '$cat'"
              echo "Response:"
              tail -n 50 /tmp/resp.txt || true
              failures=$((failures+1))
            fi

            if [[ $i -lt $((${#cats[@]}-1)) ]]; then
              echo "Sleeping 20 minutes..."
              sleep $((20*60))
            fi
          done

          echo "Finished. failures=$failures"
          [[ $failures -eq 0 ]] || exit 1
